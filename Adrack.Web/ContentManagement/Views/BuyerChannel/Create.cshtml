@model Adrack.Web.ContentManagement.Models.Lead.BuyerChannelModel

@using Adrack.Service.Helpers

@{
    Html.AddPageTitle(T("PageTitle.Register").Text);

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/core.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/interactions.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/effects.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/interactions.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/uniform.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/blockui.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/trees/fancytree_all.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/trees/fancytree_childcounter.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/ContentManagement/Scripts/plugins/duallistbox.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/form.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/form.wizard.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/select2.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jasny.bootstrap.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/validate.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/forms/selects/bootstrap_multiselect.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/ui/moment/moment.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/tables/datatables/datatables.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/ContentManagement/Scripts/plugins/notifications/pnotify.min.js").ToLowerInvariant());

    //Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/domain/membership/register.js").ToLowerInvariant());
    Html.AppendPageCustom(PageLayoutPosition.ContainerAttribute, "login-container");

    var currentUser = this.AppContext.AppUser;
    var stepIndex = 0;
}

<style>
    .invalid-filter-value {
        color: red;
    }
</style>

    <script>
    var selectedNode = null;
    var editMode = false;
    var xmlTpl = '';
    var fieldsSelect = [];
    var campaignFields = [];
    var buyerChannelId = 0;
    var isClone = false;
    var filterRowNum = 0;

    var allowedAffiliateChannels = [

        @Html.Raw(Model.AllowedAffiliateChannels)

    ];


    function onScheduleRowClone(row) {
        var $tableBody = $('#schedule').find("tbody"),
        $trLast = $tableBody.find("tr:last"),
        $trNew = row.clone();

        $trNew.find('.daysofweek').val(row.find('.daysofweek').val());
        $trNew.find('.fromhours').val(row.find('.fromhours').val());
        $trNew.find('.fromminutes').val(row.find('.fromminutes').val());
        $trNew.find('.tohours').val(row.find('.tohours').val());
        $trNew.find('.tominutes').val(row.find('.tominutes').val());
        

        $trLast.after($trNew);
    }

    function campaignTemplateChange(e) {

        var defaultValue = '';

        for (var i = 0; i < fieldsSelect.length; i++) {
            if (fieldsSelect[i].id == $(e).val()) {

                var obj = fieldsSelect[i].filterSettings;

                try {
                    if (obj !== undefined && obj !== null && obj.constructor != Object) {
                        obj = $.parseJSON(fieldsSelect[i].filterSettings);
                    }

                    if (obj.filterType == 1) {
                        $(e).parent().parent().children('td').eq(2).html('<textarea class="first-value form-control" style="resize: none; height: 36px;"  data-validatorvalue="' + fieldsSelect[i].validatorValue + '">' + obj.filterTypeValue + '</textarea>');
                    }
                    else {
                        var res = obj.filterTypeValue.split(',');
                        var html = '<select  class="first-value multiselect" style="resize: none; height: 36px;" multiple="multiple" data-validatorvalue="" data-validator="0">';
                        for (var j = 0; j < res.length; j++) {
                            html += '<option ' + (defaultValue == res[j] ? 'selected="selected"' : '') + ' value="' + res[j].trim()  + '">' + res[j].trim() + "</option>";
                        }
                        html += '</select>';
                        $(e).parent().parent().children('td').eq(2).html(html);
                    }
                }
                catch (ex) {
                    $(e).parent().parent().children('td').eq(2).html('<textarea class="first-value form-control" style="resize: none; height: 36px;" data-validatorvalue="' + fieldsSelect[i].validatorValue + '" data-validator="' + fieldsSelect[i].validator + '"></textarea>');
                }

                break;
            }
        }
       
        $(e).parent().parent().children('td').eq(2).children(".multiselect").multiselect("destroy");
        $(e).parent().parent().children('td').eq(2).children(".multiselect").multiselect({ buttonWidth: '100%' });
    }



    function allowedChanged(e) {
        for (var i = 0; i < allowedAffiliateChannels.length; i++) {
            if (allowedAffiliateChannels[i][0] == $(e).data('id')) {
                allowedAffiliateChannels[i][1] = $(e).is(':checked');
                return;
            }
        }

        allowedAffiliateChannels.push([$(e).data('id'), $(e).is(':checked')]);
    }

     function addFilterRow(field, condition, value, value2, operator, parentid = 0, existing = false) {

        var addChildBtn = '';
        var subIcon = '';
        var forsubselect = '';

        if (parentid == 0) {
            filterRowNum++;
            addChildBtn = '<div class="add_child_btn" data-id="' + filterRowNum + '"><i class="glyphicon glyphicon-plus-sign green"></i></div>';
        } else {
            subIcon = '<div class="subitem-ico"><i class="glyphicon glyphicon-chevron-right"></i></div>';
            forsubselect = 'forsubselect';
        }

        var html = '<tr class="row_' + filterRowNum + '">';
        html += '<td>';
        html += subIcon;

        html += '<select class="fields form-control ' + forsubselect + '" data-id="' + filterRowNum + '" data-parent-id="' + parentid + '" style="width: 400px"  onchange="campaignTemplateChange(this)">';

        var selected = '';
        if (fieldsSelect.length == 0)
        {
            @foreach(var t in Model.CampaignTemplate)
            {
                @Html.Raw("selected = ''; if (field == " + t.Id.ToString() + ") selected = 'selected';");
                @Html.Raw("html += '<option value=\"" + t.Id.ToString() + "\" ' + selected +'>" + t.TemplateField + "</option>';");

                @Html.Raw("fieldsSelect.push({ id: " + t.Id.ToString() + ", name: '" + t.TemplateField + "', filterSettings: '" + (!string.IsNullOrEmpty(t.FieldFilterSettings) ? t.FieldFilterSettings.Replace("\r", "").Replace("\n", "").Replace("\t", "") : "") + "', validatorValue:'" + (!string.IsNullOrEmpty(t.ValidatorValue) ? t.ValidatorValue : "") + "', validator: '" + t.Validator.ToString() + "' });");
            }
        }
        else
        {
            $.each(fieldsSelect, function (id, option) {
                selected = '';
                if (option.id == field) selected = 'selected';
                html += '<option value="' + option.id + '" ' + selected +'>' + option.name + "</option>";
            });
        }

        html += '</select>';
        html += '</td>';
        html += '<td>';
        html += '<select class="form-control">';
        html += '<option value="1" ' + (condition == '1' ? ' selected' : '') + '>CONTAINS</option>';
        html += '<option value="2" ' + (condition == '2' ? ' selected' : '') + '>DOES NOT CONTAIN</option>';
        html += '<option value="3" ' + (condition == '3' ? ' selected' : '') + '>STARTS WITH</option>';
        html += '<option value="4" ' + (condition == '4' ? ' selected' : '') + '>ENDS WITH</option>';
        html += '<option value="5" ' + (condition == '5' ? ' selected' : '') + '>EQUAL</option>';
        html += '<option value="6" ' + (condition == '6' ? ' selected' : '') + '>NOT EQUAL</option>';
        html += '<option value="7" ' + (condition == '7' ? ' selected' : '') + '>GREATER</option>';
        html += '<option value="8" ' + (condition == '8' ? ' selected' : '') + '>GREATER EQUAL</option>';
        html += '<option value="9" ' + (condition == '9' ? ' selected' : '') + '>LESS</option>';
        html += '<option value="10" ' + (condition == '10' ? ' selected' : '') + '>LESS EQUAL</option>';
        html += '<option value="11" ' + (condition == '11' ? ' selected' : '') + '>RANGE</option>';
        html += '<option value="12" ' + (condition == '12' ? ' selected' : '') + '>NO SAME DIGITS</option>';
        html += '</select>';
        html += '</td>';

        html += '<td>';
        html += '<textarea class="first-value form-control" style="resize: none; height: 36px;">' + value + '</textarea>';
        html += '</td>';

        html += '<td><div class="filter_remove"><i class="glyphicon glyphicon-remove red"></i></div></td>';
        html += '<td>' + addChildBtn + '</td>';
        html += '</tr>';


        if (parentid == 0) {
            $('#conditions tbody').append(html);
        } else
        {
            if (!existing)
                $(html).insertAfter($(".row_" + parentid).last());
            else
                $(html).insertAfter($(".row_" + filterRowNum).last());
        }

        $('.filter_remove').off('click').on('click', function () {
            $(this).parent().parent().remove();
        });
    }

    function editRow() {
        if (selectedNode == null) {
            alert('Please select the node');
            return;
        }

        editMode = true;

        $('#node_name').val(selectedNode.title);

        $('#modal_add_node').modal('show');
    }

    function deleteRow() {
        if (selectedNode == null) {
            alert('Please select the node');
            return;
        }

        selectedNode.remove();
    }

    function loadTree(source) {
        var tree = $('.tree-table').fancytree('getTree');
        tree.reload(source);

        $(".fancytree-container tr td:first-child").hide();
        $(".fancytree-container tr th:first-child").hide();
    }

    var currentMatchingButton = null;

    function loadMatchingValues(e) {
        currentMatchingButton = $(e);

        var m = $(currentMatchingButton).data('matchings');

        $("#matching_values").find('tbody').html('');

        for (var i = 0; i < m.length; i++) {
            $("#matching_values").find('tbody').append($("<tr><td><input type='text' class='form-control' value='" + m[i].input + "' /></td><td><input type='text' class='form-control' value='" + m[i].output + "' /></td><td><button onclick='deleteMathingRow(this)' class='btn btn-error'>Delete</button></td></tr>"));
        }

        console.log(m);

        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("GetBuyerChannelTemplateMatchings"))",
            data: {},
            success: function (data) {
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function deleteMathingRow(e) {
        $(e).parent().parent().remove();
    }

    function initTree() {
        $(".tree-table").fancytree({
            extensions: ["table", "dnd"],
            checkbox: true,
            keyboard: false,
            table: {
                indentation: 20,      // indent 20px per node level
                nodeColumnIdx: 1,     // render the node title into the 2nd column
                checkboxColumnIdx: 0  // render the checkboxes into the 1st column
            },
            source: [],
            lazyLoad: function (event, data) {
                data.result = { url: "ajax-sub2.json" }
            },
            renderColumns: function (event, data) {
                var node = data.node,
                $tdList = $(node.tr).find(">td");

                $(node.tr).data('folder', node.folder);

                $tdList.eq(0).data('name', "n");
                $tdList.eq(1).data('name', "campaign field");
                $tdList.eq(2).data('name', "template field");
                $tdList.eq(3).data('name', "default value");
                $tdList.eq(4).data('name', "matchings");

                if (!node.folder) {
                    var sel = '';

                    var templateField = '<select class="cmp form-control" style="width: 150px">';

                    @foreach (var item in Model.ListCampaignField)
                    {
                        @Html.Raw("if (node.data.CampaignTemplateId == " + item.Value + ") { sel = 'selected'; } else { sel = ''; }");
                        @Html.Raw("templateField += '<option value=\"" + item.Value + "\" ' + sel + '>" + item.Text + "</option>';")
                    }

                    templateField += '</select>';

                    $tdList.eq(2).addClass('text-center').html(templateField);

                    var dataList = '<datalist id="' + node.data.TemplateField + '_list">' +
                                        '<option value="[DATE GUID]">Date GUID</option>' +
                                        '<option value="[CUR DATE]">Current date</option>' +
                                        '<option value="[OPTIONAL]">Optional</option>' +
                                        '<option value="[REQUIRED]">Required</option>' +
                                   '</datalist>';

                    $tdList.eq(3).addClass('text-center').html("<input type='text' name='default_value' class='form-control' maxlength='150' value='" + node.data.DefaultValue + "' list='" + node.data.TemplateField + "_list'>" + dataList);

                    var btn = $("<button  data-field='" + node.data.TemplateField + "' type='button' class='btn btn-default btn-sm' data-toggle='modal' data-target='#matching_values_modal' onclick='loadMatchingValues(this)' data-matchings=''>Matching value</button>")

                    console.log($(btn));

                    $tdList.eq(4).addClass('text-center').append($(btn));
                    $tdList.eq(4).addClass('text-center').append('<span id="' + node.data.TemplateField + '_matching_span" class="show-matchings text-blue" data-info=""></span>');

                    try {
                        $(btn).data('matchings', JSON.parse(node.data.Matchings));
                    }
                    catch (err) {
                    }

                    $(node.tr).find(".styled").uniform({ radioClass: 'choice' });

                    FillCampaignDropdown($(node.tr).find(".cmp"), node.title, node.data.CampaignTemplateId);

                    //$(node.tr).find(".select-search").select2();
                }
                //$(".select-search").off("select2:select").on("select2:select", function (e) { $(this).parent().data('value', e.params.data.id); console.log(e); });
            },
            activate: function (event, data) {
                selectedNode = data.node;
            },
            select: function (event, data) {
                console.log(data);
                // Display list of selected nodes
                //var s = data.tree.getSelectedNodes().join(", ");
                //$("#echoSelection1").text(s);
            },
            dnd: {
                preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
                preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
                autoExpandMS: 400,
                draggable: {
                    //zIndex: 1000,
                    // appendTo: "body",
                    // helper: "clone",
                    scroll: false,
                    revert: "invalid"
                },
                dragStart: function (node, data) {
                    if (data.originalEvent.shiftKey) {
                        console.log("dragStart with SHIFT");
                    }
                    // allow dragging `node`:
                    return false;
                },
                dragEnter: function (node, data) {
                    // Prevent dropping a parent below another parent (only sort
                    // nodes under the same parent)
                    /* 					if(node.parent !== data.otherNode.parent){
                                            return false;
                                        }
                                        // Don't allow dropping *over* a node (would create a child)
                                        return ["before", "after"];
                    */
                    return true;
                },
                dragDrop: function (node, data) {
                    if (!data.otherNode) {
                        // It's a non-tree draggable
                        var title = $(data.draggable.element).text() + " (" + (count)++ + ")";
                        node.addNode({ title: title }, data.hitMode);
                        return;
                    }
                    data.otherNode.moveTo(node, data.hitMode);
                    $(node.tr).data('folder', true);
                    console.log(node.tr);
                }
            }
        });
    }

    function LoadBChannelTemplate(achannelid) {
        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("LoadBuyerChannelTemplate"))",
            data: { achannelid: achannelid, xml: $('#xml_template').val() },
            success: function (data) {
                loadTree(data);
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function LoadCampaignTemplate(campaignid) {
        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("loadcampaigntemplatelist"))",
            data: { campaignid: campaignid },
            success: function (data) {
                campaignFields = [];
                $.each(data, function (id, option) {
                    campaignFields.push({ id: option.id, name: option.name });
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function FillCampaignDropdown(e, title, campaigntemplateid) {
        $(e).html('');
        $(e).append($('<option></option>').val(0).html("NONE").attr('selected', true));
        $.each(campaignFields, function (id, option) {
            console.log(isClone, option.id, campaigntemplateid);
            if ((!isClone && option.name != title) || (isClone && option.id != campaigntemplateid))
                $(e).append($('<option></option>').val(option.id).html(option.name));
            else {
                $(e).find('option').removeAttr('selected');
                $(e).append($('<option></option>').attr('selected', true).val(option.id).html(option.name));
            }
        });
    }

    function getNodes(tree, parent, parentName, ar) {
        if (parent.children != null) {
            if (parent.children.length > 0 && parent.title != parentName) {
                ar.push([]);

                ar[ar.length - 1].push(parent.title);
                ar[ar.length - 1].push("0");
                ar[ar.length - 1].push("");
                ar[ar.length - 1].push('');
                ar[ar.length - 1].push(parentName);
            }

            for (var i = 0; i < parent.children.length; i++) {
                if (parent.children[i].children == null || parent.children[i].children.length == 0) {
                    ar.push([]);

                    $(parent.children[i].tr).children('td').each(function () {
                        var value = null;

                        if ($(this).data('name') == "campaign field") {
                            value = $(this).find(".fancytree-title").text();
                        }
                        else
                            if ($(this).data('name') == "template field") {
                                value = $(this).find("select").val();
                            }
                            else
                                if ($(this).data('name') == "default value") {
                                    value = $(this).find("input").val();
                                }
                                else
                                    if ($(this).data('name') == "matchings") {
                                        value = $(this).find("button").data('matchings');
                                    }

                        if (value != null)
                            ar[ar.length - 1].push(value);
                    });

                    ar[ar.length - 1].push(parent.title);
                }
                else
                    ar = getNodes(tree, parent.children[i], parent.title, ar);
            }
        }

        return ar;
    }

    function addNodeDialog() {
        editMode = false;
        $('#modal_add_node').modal('show');
    }

    var step4Clone = null;
    var step3Clone = null;
    var campaignFieldsClone = null;

    function LoadCampaignXml(selectedItem) {
        $.ajax({
            cache: false,
            type: "POST",
            url: "@(Url.RouteUrl("LoadFromCampaignXml2"))",
            data: { campaignid: selectedItem },
            success: function (data) {
                xmlTpl = data.xml;
                LoadCampaignTemplate(selectedItem);
                loadTree(data.items);

                $('.cmp').each(function () {
                    var text = $(this).parent().parent().find('.fancytree-title').text();
                    console.log(text);
                    $(this).find('option:contains(' + text + ')').each(function () {
                        if ($(this).text() == text) {
                            $(this).attr('selected', 'selected');
                            return false;
                        }
                        return true;
                    });
                    $(this).change();
                });

                $('.modal-body').unblock();
                $('#modal_default').modal('hide');
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function LoadBuyerChannels(buyerid, campaignid) {
        var ddlBuyerChannels = $("#BuyerChannelTemplateId");
        var child_channels = $("#child_channels");

        $.ajax({
            cache: false,
            type: "GET",
            url: "@(Url.RouteUrl("GetBuyerChannels"))",
            data: { "bid": '', mode: 1, Params: campaignid },
            success: function (data) {
                ddlBuyerChannels.html('');
                ddlBuyerChannels.append($('<option></option>').val(0).html('Select buyer channel'));
                child_channels.html('');
                $.each(data.data, function (id, option) {
                    ddlBuyerChannels.append($('<option></option>').val(option[0]).html(option[1]));
                    child_channels.append($('<option></option>').val(option[0]).html(option[1]));
                });
                $('#child_channels').bootstrapDualListbox('refresh', true);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function LoadFromBuyerChannelXml(xml, buyerchannelid) {
        $.ajax({
            cache: false,
            type: "POST",
            url: "@(Url.RouteUrl("LoadFromBuyerChannelXml"))",
            data: { xml: xml, buyerchannelid: buyerchannelid },
            success: function (data) {
                LoadCampaignTemplate($("#@Html.FieldIdFor(x => x.CampaignId)").val());
                loadTree(data.items);

                xmlTpl = data.xml;

                if (buyerchannelid == null) {
                    $('.modal-body').unblock();
                    $('#modal_default').modal('hide');
                }
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function LoadFromBuyerChannelInfo(buyerchannelid) {
        $.ajax({
            cache: false,
            type: "POST",
            url: "@(Url.RouteUrl("GetBuyerChannelInfo"))",
            data: { id: buyerchannelid },
            success: function (data) {
                $('#AcceptedField').val(data.AcceptedField);
                $('#AcceptedValue').val(data.AcceptedValue);
                $('#AcceptedFrom').val(data.AcceptedFrom);
                $('#ErrorField').val(data.ErrorField);
                $('#ErrorValue').val(data.ErrorValue);
                $('#ErrorFrom').val(data.ErrorFrom);
                $('#RejectedField').val(data.RejectedField);
                $('#RejectedValue').val(data.RejectedValue);
                $('#RejectedFrom').val(data.RejectedFrom);
                $('#TestField').val(data.TestField);
                $('#TestValue').val(data.TestValue);
                $('#TestFrom').val(data.TestFrom);

                $('#RedirectField').val(data.RedirectField);
                $('#MessageField').val(data.MessageField);
                $('#PriceField').val(data.PriceField);

                $('#ResponseFormat').val(data.ResponseFormat);
                $('#PostingUrl').val(data.PostingUrl);
                $('#PostingHeaders').val(data.PostingHeaders);
                $('#DataFormat').val(data.DataFormat);

                $('#WinResponseUrl').val(data.WinResponseUrl);
                $('#WinResponsePostMethod').val(data.WinResponsePostMethod);
                $('#PriceRejectWinResponse').val(data.PriceRejectWinResponse);
                $('#LeadIdField').val(data.LeadIdField);

                $('#AccountIdField').val(data.AccountIdField);
                $('#PriceRejectValue').val(data.PriceRejectValue);
                $('#PriceRejectField').val(data.PriceRejectField);
                $('#Delimeter').val(data.Delimeter);
                $('#EnableCustomPriceReject').prop('checked', data.EnableCustomPriceReject);
                $('#FieldAppendEnabled').prop('checked', data.FieldAppendEnabled);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    var canRedirect = false;

    function conditionChanged(e) {
        var selectedVal = $(e).val();

        if (selectedVal == 11) {
            $(e).parent().parent().find('.second-value').show();
        }
        else {
            $(e).parent().parent().find('.second-value').hide();
        }
    }

    $(document).ready(function () {

        $('#child_channels').bootstrapDualListbox({
            preserveSelectionOnMove: 'moved',
            moveOnSelect: false,
            nonSelectedListLabel: 'Excluded',
            selectedListLabel: 'Included (Represent Tiers)',
            showFilterInputs: true
        });

        $("#@Html.FieldIdFor(x => x.AffiliatePriceOption)").change(function () {
            var selectedItem = $(this).val();

            if (selectedItem == 0) {
                $('#AffiliatePriceMessage').hide();
                //$("#@Html.FieldIdFor(x => x.AffiliatePrice)").attr('readonly', false);
                $('#AffiliatePriceOptionLabel').text($('#AffiliatePriceOptionLabel').data('value'));
                //$("#@Html.FieldIdFor(x => x.AffiliatePrice)").val($("#@Html.FieldIdFor(x => x.AffiliatePrice)").data('value'));
            }
            else
                if (selectedItem == 1) {
                    $('#AffiliatePriceMessage').show();
                    //$("#@Html.FieldIdFor(x => x.AffiliatePrice)").attr('readonly', true);
                    //share
                    $('#AffiliatePriceOptionLabel').data('value', $('#AffiliatePriceOptionLabel').text());
                    $('#AffiliatePriceOptionLabel').text('Share (%)');
                    //$("#@Html.FieldIdFor(x => x.AffiliatePrice)").data('value', $("#@Html.FieldIdFor(x => x.AffiliatePrice)").val());
                    //$("#@Html.FieldIdFor(x => x.AffiliatePrice)").val('0');
                }
        });

        $("#@Html.FieldIdFor(x => x.BuyerPriceOption)").change(function () {
            return;
            var selectedItem = $(this).val();

            if (selectedItem == 0) {
                $("#@Html.FieldIdFor(x => x.BuyerPrice)").attr('readonly', false);
                $("#@Html.FieldIdFor(x => x.BuyerPrice)").val($("#@Html.FieldIdFor(x => x.BuyerPrice)").data('value'));
            }
            else
                if (selectedItem == 1) {
                    $("#@Html.FieldIdFor(x => x.BuyerPrice)").attr('readonly', true);
                    $("#@Html.FieldIdFor(x => x.BuyerPrice)").data('value', $("#@Html.FieldIdFor(x => x.BuyerPrice)").val());
                    $("#@Html.FieldIdFor(x => x.BuyerPrice)").val('0');
                }
        });

        $("#@Html.FieldIdFor(x => x.AlwaysSoldOption)").change(function () {

            return;

            var selectedItem = $(this).val();

            var ddlBuyerPriceOption = $("#@Html.FieldIdFor(x => x.BuyerPriceOption)");

            ddlBuyerPriceOption.html('');

            if (selectedItem == 0) {
                ddlBuyerPriceOption.append($('<option></option>').val(0).html('Fixed'));
                ddlBuyerPriceOption.append($('<option></option>').val(1).html('Dynamic'));

                var step4 = $("#step4-tpl").clone();
                step4.insertAfter("#step3");

                step4.attr('id', 'step4');

                $(".form-validation").formwizard("update_steps");
            }
            else {
                ddlBuyerPriceOption.append($('<option></option>').val(0).html('Fixed'));
                $("#step4").remove(); // remove the added car and car_more steps
                $(".form-validation").formwizard("update_steps");

                // remove the visited car step from the wizards internal "memory"
                var steps = $(".form-validation").formwizard("state").activatedSteps;
                $(".form-validation").formwizard("option", "activatedSteps", steps.pop());
            }
        });

        $(".form-validation").formwizard({
            disableUIStyles: true,
            validationEnabled: true,
            inDuration: 150,
            outDuration: 150,
            validationOptions: {
                ignore: 'input[type=hidden], .select2-search__field',
                errorClass: 'validation-error-label',
                successClass: 'validation-valid-label',
                highlight: function (element, errorClass) {
                    $(element).removeClass(errorClass);
                },
                unhighlight: function (element, errorClass) {
                    $(element).removeClass(errorClass);
                },

                // Different components require proper error label placement
                errorPlacement: function (error, element) {

                    // Styled checkboxes, radios, bootstrap switch
                    if (element.parents('div').hasClass("checker") || element.parents('div').hasClass("choice") || element.parent().hasClass('bootstrap-switch-container')) {
                        if (element.parents('label').hasClass('checkbox-inline') || element.parents('label').hasClass('radio-inline')) {
                            error.appendTo(element.parent().parent().parent().parent());
                        }
                        else {
                            error.appendTo(element.parent().parent().parent().parent().parent());
                        }
                    }
                        // Unstyled checkboxes, radios
                    else if (element.parents('div').hasClass('checkbox') || element.parents('div').hasClass('radio')) {
                        error.appendTo(element.parent().parent().parent());
                    }

                        // Input with icons and Select2
                    else if (element.parents('div').hasClass('has-feedback') || element.hasClass('select2-hidden-accessible')) {
                        error.appendTo(element.parent());
                    }

                        // Inline checkboxes, radios
                    else if (element.parents('label').hasClass('checkbox-inline') || element.parents('label').hasClass('radio-inline')) {
                        error.appendTo(element.parent().parent());
                    }

                        // Input group, styled file input
                    else if (element.parent().hasClass('uploader') || element.parents().hasClass('input-group')) {
                        error.appendTo(element.parent().parent());
                    }

                    else {
                        error.insertAfter(element);
                    }
                },
                rules: {
                    Email: {
                        email: true
                    },
                    Timeout: {
                        number: true
                    },
                    MaxDuplicateDays: {
                        number: true
                    },
                    AffiliatePrice: {
                        number: true
                    },
                    BuyerPrice: {
                        number: true
                    }
                }
            }
        });

        $('#matchingModalSave').on('click', function () {

            var matchings = [];

            $("#matching_values tbody tr").each(function () {
                var inputValue = $(this).children('td').eq(0).children('input').val();
                var outputValue = $(this).children('td').eq(1).children('input').val();

                matchings.push({ input: inputValue, output: outputValue });

                console.log(inputValue, outputValue);
            });

            currentMatchingButton.data('matchings', matchings);

            if (currentMatchingButton != null && matchings.length > 0) {
                var field = $(currentMatchingButton).data('field');
                $('#' + field + '_matching_span').html('<i class="icon-arrow-resize7"></i>');
            }
            else
                $('#' + field + '_matching_span').html('');
        });

        $('#addMatchingBtn').on('click', function () {
            $("#matching_values").find('tbody').append($("<tr><td><input type='text' class='form-control' value='" + $('#inputValue').val() + "' /></td><td><input type='text' class='form-control' value='" + $('#outputValue').val() + "' /></td><td><button onclick='deleteMathingRow(this)'  style='height:36px'>Delete</button></td></tr>"));
            $('#inputValue').val('');
            $('#outputValue').val('');
        });

        $('#filter_templates').on('change', function (e) {
            var selectedItem = $(this).val();
            if (selectedItem == 0) return;

            if (!confirm('Are you sure you want to apply the filter template?')) {
                e.preventDefault();
                return;
            }

            if (selectedItem == null) return;
            $.ajax({
                cache: false,
                type: "POST",
                url: "/getfilterconditions",
                data: { filterid: selectedItem },
                success: function (data) {
                    //$('#conditions tbody').html('');
                    $.each(data, function (id, option) {
                        console.log(option);
                        addFilterRow(option.field, option.condition, option.value, option.value2, option.op, option.parent);
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });
        });

        $('#filter_add').click(function () {
            addFilterRow(0, 0, '', '', 0, 0);
            campaignTemplateChange($( ".fields" ).last().get(0));
        });

        $("#@Html.FieldIdFor(x => x.BuyerId)").change(function () {
            var selectedItem = $(this).val();

            if (selectedItem == '') return;

            $.ajax({
                cache: false,
                type: "POST",
                url: "/management/user/getbuyerfirstuser",
                data: { buyerId: selectedItem },
                success: function (data) {
                    $("#@Html.FieldIdFor(x => x.NotificationEmail)").val(data.email);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });

            var ddlBuyerPriceOption = $("#@Html.FieldIdFor(x => x.BuyerPriceOption)");

            $.ajax({
                cache: false,
                type: "POST",
                url: "/management/buyer/getbuyerinfo",
                data: { buyerId: selectedItem },
                success: function (data) {

                    $("#@Html.FieldIdFor(x => x.MaxDuplicateDays)").val(data.maxduplicatedays);

                    return;

                    ddlBuyerPriceOption.html('');

                    if (data.type == 0) {
                        if (step3Clone != null) {
                            step3Clone.insertAfter('#step2');
                            step3Clone = null;
                            $("#@Html.FieldIdFor(x => x.PostingUrl)").attr('required', 'required');
                            $("#@Html.FieldIdFor(x => x.MaxDuplicateDays)").attr('required', 'required');
                            $(".online-options").show();

                            ddlBuyerPriceOption.append($('<option></option>').val(0).html('Fixed'));
                            ddlBuyerPriceOption.append($('<option></option>').val(1).html('Dynamic'));
                        }
                    }
                    else {
                        $("#@Html.FieldIdFor(x => x.PostingUrl)").removeAttr('required');
                        $("#@Html.FieldIdFor(x => x.MaxDuplicateDays)").removeAttr('required');
                        step3Clone = $('#step3').clone(true);
                        $('#step3').remove();
                        $(".online-options").hide();
                        ddlBuyerPriceOption.append($('<option></option>').val(0).html('Fixed'));
                    }

                    $(".form-validation").formwizard("update_steps");
                },
                error: function (xhr, ajaxOptions, thrownError) {
                }
            });
        });

        $("#@Html.FieldIdFor(x => x.CampaignId)").change(function () {
            var selectedItem = $(this).val();
            if (selectedItem > 0) {
                var tree = $(".tree-table").fancytree("getTree");
                LoadCampaignXml(selectedItem);

                $.ajax({
                    cache: false,
                    type: "POST",
                    url: "/GetFiltersByCampaignId",
                    data: { campaignid: selectedItem },
                    success: function (data) {
                        $('#filter_templates').html('');
                        $('#filter_templates').append($('<option></option>').val(0).html('Select a set'));
                        $.each(data, function (id, option) {
                            $('#filter_templates').append($('<option></option>').val(option.id).html(option.name));
                        });
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('Failed to retrieve user email.');
                    }
                });

                $.ajax({
                    cache: false,
                    type: "POST",
                    url: "/GetCampaignFields",
                    data: { campaignid: selectedItem },
                    success: function (data) {
                        var html = '<select class="fields form-control">';
                        fieldsSelect = [];
                        $.each(data, function (id, option) {
                            fieldsSelect.push({ id: option.id, name: option.name, filterSettings: option.filterSettings, validatorValue: option.validatorValue, validator: option.validator });
                            html += '<option value="' + option.id + '">' + option.name + "</option>";
                        });
                        html += '</select>';
                        $('#conditions tbody tr').children('td').eq(0).html(html);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('Failed to retrieve user email.');
                    }
                });

//                GenerateGridTable("allowed_from", "/management/buyerchannel/getallowedfrom?campaignid=" + selectedItem, "ID, Name, Status");

                var buyerid = $("#@Html.FieldIdFor(x => x.BuyerId)").val();
                if (buyerid == '')
                    buyerid = 0;
                LoadBuyerChannels(buyerid, selectedItem);
            }
        });

        $("#@Html.FieldIdFor(x => x.BuyerId)").change(function () {
            var selectedItem = $(this).val();

            if (selectedItem == 0) return;

            var campaignId = $("#@Html.FieldIdFor(x => x.CampaignId)").val();

            //LoadBuyerChannels(selectedItem, campaignId);
        });

        $("#@Html.FieldIdFor(x => x.BuyerId)").trigger('change');

        $("#BuyerChannelTemplateId").change(function () {
            var selectedItem = $(this).val();

            if (selectedItem == 0) return;

            isClone = true;

            LoadFromBuyerChannelXml(null, selectedItem);
            LoadFromBuyerChannelInfo(selectedItem);
        });

        $('.select').select2();

        $('#btnSubmitClose').on('click', function () {
            canRedirect = true;
            return true;
        });

        $('#item-form').on('submit', function (e) {
            e.preventDefault();

            var form = $(this);

            var submitBtn = form.find(':submit');
            submitBtn.attr('disabled', 'disabled');

            $('#tab-main').trigger('click');

            var btn = $(":input[type=submit]:focus");
            var sn = null;
            var lastsn = "";
            var canContinue = true;

            var schedule = [];
            $('#schedule tbody tr').each(function () {
                var day = $(this).children('td').eq(0).find('select').val();
                var fromhour = $(this).children('td').eq(1).find('select').eq(0).val();
                var fromminute = $(this).children('td').eq(1).find('select').eq(1).val();

                var tohour = $(this).children('td').eq(2).find('select').eq(0).val();
                var tominute = $(this).children('td').eq(2).find('select').eq(1).val();

                var qty = $(this).children('td').eq(3).find('input').val();
                var pwait = $(this).children('td').eq(4).find('input').val();
                var swait = $(this).children('td').eq(5).find('input').val();
                var hmax = $(this).children('td').eq(6).find('input').val();

                var price = $(this).children('td').eq(7).find('input').val();
                var status = $(this).children('td').eq(8).find('select').val();

                schedule.push({ day: day, fromHour: fromhour, fromMinute: fromminute, toHour: tohour, toMinute: tominute, quantity: qty, pwait: pwait, swait: swait, hmax: hmax, price: price, status: status });
            });

            var clickPrices = [];
            /*$('#clickPrices tbody tr').each(function () {
                var type = $(this).children('td').eq(0).children('input').val();
                var price = $(this).children('td').eq(1).children('input').val();

                clickPrices.push({ type: type, price: price });
            });*/
            var pricesJson = JSON.stringify(clickPrices);

            var schjson = JSON.stringify(schedule);
            var allowedjson = JSON.stringify(allowedAffiliateChannels);

            var conditions = [];

            $('#conditions tbody tr').each(function () {
                var field = $(this).children('td').eq(0).children('select').val();
                var condition = $(this).children('td').eq(1).children('select').val();
                var value = $(this).children('td').eq(2).children('.first-value').val();
                var validator = $(this).children('td').eq(2).children('.first-value').data('validator');
                var validatorValue = $(this).children('td').eq(2).children('.first-value').data('validatorvalue');
                var parent = $(this).children('td').eq(0).children('select').data('parent-id');
                var operator = 0;

                $(this).children('td').eq(2).children('.invalid-filter-value').remove();

                var us = new RegExp("^\\d{5}(-{0,1}\\d{4})?$");
                var ca = new RegExp(/([ABCEGHJKLMNPRSTVXY]\d)([ABCEGHJKLMNPRSTVWXYZ]\d){2}/i);

                if (Array.isArray(value)) {
                    var val = '';
                    for (var i = 0; i < value.length; i++) {
                        val += value[i];
                        if (validator == 7) {
                            if (validatorValue == 'us' && !us.test(value[i].trim()) || validatorValue == 'ca' && !ca.test(value[i].trim())) {
                                $(this).children('td').eq(2).append('<span class="invalid-filter-value"><b>Invalid zip code</b></span>');
                                canContinue = false;
                                break;
                            }
                        }
                        if (i < value.length - 1)
                            val += ",";
                    }
                    value = val;
                }
                else if (value != null && value != undefined) {
                    value = value.replace(/\n/g, ",");
                    var values = value.split(",");
                    for (var i = 0; i < values.length; i++) {
                        if (validator == 7) {
                            if (validatorValue == 'us' && !us.test(values[i].trim()) || validatorValue == 'ca' && !ca.test(values[i].trim())) {
                                $(this).children('td').eq(2).append('<span class="invalid-filter-value"><b>Invalid zip code</b></span>');
                                canContinue = false;
                                break;
                            }
                        }
                    }
                    $(this).children('td').eq(2).children('.first-value').val(value);
                }

                conditions.push({ field: field, condition: condition, value: value, operator: operator, parent: parent });
            });

            if (!canContinue) {
                submitBtn.removeAttr('disabled');
                return;
            }

            var conditionsjson = JSON.stringify(conditions);

            tpl = [];

            var tree = $(".tree-table").fancytree("getTree");
            tpl = getNodes(tree, tree.rootNode, "root", tpl);

            if (tpl.length == 0) {
                alert('Affiliate channel template is not defined');
                return;
            }

            var tpljson = JSON.stringify(tpl);

            var a = $('#child_channels').val();

            var child_channels = '';

            if (a != undefined) {
                for (var i = 0; i < a.length; i++) {
                    child_channels += a[i];
                    if (i < a.length - 1)
                        child_channels += ',';
                }
            }

            ShowLoader();

            $.ajax({
                url: $(this).attr('action'),
                type: "POST",
                async: true,
                data: $(this).serialize() + '&json=' + tpljson + '&xml=' + xmlTpl + '&schedule=' + schjson + '&conditions=' + conditionsjson + '&allowed=' + '' + '&prices' + pricesJson + '&childchannels=' + child_channels,
                success: function (data) {
                    HideLoader();

                    NotificationPopup('Success', 'Buyer channel successfully saved');

                    if (data.error != undefined) {
                        submitBtn.removeAttr('disabled');
                        alert(data.error);
                    }
                    else {
                        if ('true' == '@Model.ReturnToLocalList.ToString().ToLower()') {
                            window.location = '/Management/Buyer/Channels/@Model.BuyerId';
                        }
                        else {
                            window.location = '/management/buyerchannel/item/' + data.id;
                        }
                    }

                    canRedirect = false;
                },
                error: function (jXHR, textStatus, errorThrown) {
                    HideLoader();
                }
            });

            return false;
        });

        initTree();

        $('#load_template_btn').click(function () {

            $('.modal-body').block({
                message: '<i class="icon-spinner2 spinner"></i>',
                overlayCSS: {
                    backgroundColor: '#1B2024',
                    opacity: 0.85,
                    cursor: 'wait'
                },
                css: {
                    border: 0,
                    padding: 0,
                    backgroundColor: 'none',
                    color: '#fff'
                }
            });

            xmlTpl = $('#xml_template').val();

            isClone = false;

            LoadFromBuyerChannelXml(xmlTpl, null);
        });

        $('.schedule_remove').click(function () {
            $(this).parent().parent().remove();
        });

        $('.filter_remove').click(function () {
            $(this).parent().parent().remove();
        });

        $('#schedule_add').click(function () {

            var day = $('#schedule_day').val();

            var fromhour = 0;
            var fromminute = 0;

            var tohour = 24;
            var tominute = 0;

            var html = '<tr>';
            html += '<td>';
            html += '<select class="form-control">';
            html += '<option' + (day == 'Sunday' ? ' selected' : '') + '>Sunday</option>';
            html += '<option' + (day == 'Monday' ? ' selected' : '') + '>Monday</option>';
            html += '<option' + (day == 'Tuseday' ? ' selected' : '') + '>Tuseday</option>';
            html += '<option' + (day == 'Wednesday' ? ' selected' : '') + '>Wednesday</option>';
            html += '<option' + (day == 'Thursday' ? ' selected' : '') + '>Thursday</option>';
            html += '<option' + (day == 'Friday' ? ' selected' : '') + '>Friday</option>';
            html += '<option' + (day == 'Saturday' ? ' selected' : '') + '>Saturday</option>';
            html += '</select>';
            html += '</td>';

            html += '<td style="width: 130px">';
            html += '<select class="form-control">';
            for (var i = 0; i <= 24; i++) {
                var selected = '';
                if (i == fromhour) selected = ' selected';
                if (i < 10)
                    html += '<option' + selected + '>0' + i + '</option>';
                else
                    html += '<option' + selected + '>' + i + '</option>';
            }
            html += '</select>';
            html += '<select class="form-control">';
            for (var i = 0; i <= 59; i++) {
                var selected = '';
                if (i == fromminute) selected = ' selected';
                if (i < 10)
                    html += '<option' + selected + '>0' + i + '</option>';
                else
                    html += '<option' + selected + '>' + i + '</option>';
            }
            html += '</select>';
            html += '</td>';

            html += '<td style="width: 130px">';
            html += '<select class="form-control">';
            for (var i = 0; i <= 24; i++) {
                var selected = '';
                if (i == tohour) selected = ' selected';
                if (i < 10)
                    html += '<option' + selected + '>0' + i + '</option>';
                else
                    html += '<option' + selected + '>' + i + '</option>';
            }
            html += '</select>';
            html += '<select class="form-control">';
            for (var i = 0; i <= 59; i++) {
                var selected = '';
                if (i == fromminute) selected = ' selected';
                if (i < 10)
                    html += '<option' + selected + '>0' + i + '</option>';
                else
                    html += '<option' + selected + '>' + i + '</option>';
            }
            html += '</select>';
            html += '</td>';

            html += '<td>';
            html += '<input type="text" class="form-control" value="0">';
            html += '</td>';

            html += '<td>';
            html += '<input type="text" class="form-control" value="0">';
            html += '</td>';

            html += '<td>';
            html += '<input type="text" class="form-control" value="0">';
            html += '</td>';

            html += '<td>';
            html += '<input type="text" class="form-control" value="0">';
            html += '</td>';

            html += '<td>';
            html += '<input type="text" class="form-control" value="0">';
            html += '</td>';

            html += '<td>';
            html += '<select class="form-control"><option value="-1">All</option><option value="1">Sold</option><option value="3">Rejected</option></select>';
            html += '</td>';

            html += '<td><div class="schedule_remove"><i class="glyphicon glyphicon-remove red"></i></div></td>';

            html += '</tr>';

            $('#schedule tbody').append(html);

            $('.schedule_remove').off('click').on('click', function () {
                $(this).parent().parent().remove();
            });

        });

        @if (Model.CampaignId != 0)
        {
            @: $("#@Html.FieldIdFor(x => x.CampaignId)").trigger('change');
        }
    }).on("click", "body", function () {
        $(".matchings-window").hide();
    }).on("click", ".add_child_btn", function () {
        addFilterRow(0, '0', '', '', '0', $(this).data('id'));
    }).on('click', '.clone-schedule-row', function (e) {
        e.preventDefault();
        onScheduleRowClone($(this).closest('tr'));
    });;
    </script>

@using (Html.BeginForm("Item", null, FormMethod.Post, new { @class = "form-validation", id="item-form" }))
{
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="col-lg-12">
            <div class="panel registration-form">
                <div class="panel-body">

                    <div class="text-center">
                        <h4 class="content-group-lg">
                            Create buyer channel
                        </h4>
                    </div>

                    <fieldset class="step" id="step@(stepIndex++)">
                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>General info</span>
                        </h6>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.Name)
                                    @Html.TextBoxFor(x => x.Name, new { @class = "form-control", tabindex = 1, placeholder = "Buyer channel name", required = "required", maxlength = "50" })
                                </div>
                            </div>

                            @if ((currentUser.UserTypeId == SharedData.BuiltInUserTypeId || currentUser.UserTypeId == SharedData.NetowrkUserTypeId) && Model.BuyerId == 0)
                            {
                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.Label("Buyer")<br />
                                        @Html.DropDownList("BuyerId", Model.ListBuyer, new { @class = "select", required = "required", style = "width: 150px" })
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div>
                                    @Html.HiddenFor(x => x.BuyerId)
                                </div>
                            }

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Time zone")<br />
                                    @Html.DropDownList("SelectedTimeZone", Model.TimeZones, new { @class = "form-control", required = "required" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Multi Buyer Handling - channel mapping unique identifier key")
                                    @Html.TextBoxFor(x => x.ChannelMappingUniqueId, new { @class = "form-control", tabindex = 1, maxlength = "50" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group" id="revenue_div">
                                    @Html.Label("Notes")<br />
                                    @Html.TextAreaFor(x => x.Note, new { @class = "form-control", tabindex = 1, placeholder = "" })
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                             <span>More info</span>
                        </h6>

                        <div class="row" id="campaign-select-block">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Campaign")<br />
                                    @Html.DropDownList("CampaignId", Model.ListCampaign, new { @class = "select", required = "required", style = "width: 150px" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.NotificationEmail)
                                    @Html.TextBoxFor(x => x.NotificationEmail, new { @class = "form-control", tabindex = 1, placeholder = "Notification email", required = "required" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Status")<br />
                                    @Html.DropDownList("Status", Model.ListStatus, new { @class = "select", required = "required", style = "width: 150px" })
                                </div>
                            </div>
                        </div>

                        <div class="lead-campaign-fields">
                            <div class="online-options">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            @Html.Label("Url to post / EMail (for email buyers)")<br />
                                            @Html.TextBoxFor(x => x.PostingUrl, new { @class = "form-control", tabindex = 1, placeholder = "Posting url", required = "required", maxlength = "300" })
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            @Html.Label("Data format")<br />
                                            @Html.DropDownList("DataFormat", Model.ListDataFormat, new { @class = "select", required = "required", style = "width: 250px" })
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            @Html.Label("Response format")<br />
                                            @Html.DropDownList("ResponseFormat", Model.ListResponseFormats, new { @class = "select", required = "required", style = "width: 250px" })
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            @Html.LabelFor(x => x.PostingHeaders)
                                            @Html.TextAreaFor(x => x.PostingHeaders, new { @class = "form-control", tabindex = 1, placeholder = "Posting headers" })
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            @Html.LabelFor(x => x.Timeout)
                                            @Html.TextBoxFor(x => x.Timeout, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "Timeout", required = "required" })
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            @Html.LabelFor(x => x.MaxDuplicateDays)
                                            @Html.TextBoxFor(x => x.MaxDuplicateDays, new { @class = "form-control", tabindex = 1, placeholder = "Max leads per day", required = "required", min = "0", max = "180" })
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.LabelFor(x => x.AffiliatePriceOption)
                                        @Html.DropDownList("AffiliatePriceOption", Model.ListAffiliatePriceOption, new { @class = "select", style = "width: 100px" })
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.LabelFor(x => x.AffiliatePrice, new { id = "AffiliatePriceOptionLabel", data_value = "Affiliate price" })
                                        @Html.TextBoxFor(x => x.AffiliatePrice, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "Affiliate price", required = "required", data_value = Model.AffiliatePrice })
                                        <div>
                                            <span id="AffiliatePriceMessage" style="color: red; font-size: 10px; display: none">The system will check rev-share % value from affiliates</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.LabelFor(x => x.BuyerPriceOption)
                                        @Html.DropDownList("BuyerPriceOption", Model.ListBuyerPriceOption, new { @class = "select", style = "width: 100px" })
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.LabelFor(x => x.BuyerPrice)
                                        @Html.TextBoxFor(x => x.BuyerPrice, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "Buyer price", required = "required", data_value = Model.BuyerPrice })
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.CheckBoxFor(x => x.CapReachedNotification, new { tabindex = 1 }) &nbsp;
                                        @Html.LabelFor(x => x.CapReachedNotification)
                                    </div>
                                </div>

                                <div class="online-options">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            @Html.CheckBoxFor(x => x.TimeoutNotification, new { tabindex = 1 }) &nbsp;
                                            @Html.LabelFor(x => x.TimeoutNotification)

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        @Html.CheckBoxFor(x => x.StatusAutoChange, new { tabindex = 1 }) &nbsp;
                                        @Html.Label("Pause the channel")
                                    </div>

                                    <div class="form-group">
                                        @Html.Label("Pause for (min)")
                                        @Html.TextBoxFor(x => x.StatusChangeMinutes, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "", required = "" })
                                    </div>

                                    <div class="form-group">
                                        @Html.Label("Pause after timeouts")
                                        @Html.TextBoxFor(x => x.ChangeStatusAfterCount, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "", required = "" })
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        @Html.LabelFor(x => x.RedirectUrl)
                                        @Html.TextBoxFor(x => x.RedirectUrl, new { @class = "form-control", type = "text", tabindex = 1, placeholder = "Redirect url" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--<div class="row">
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table id="clickPrices" class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Price</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Cost per Conversion (CPA)<input type="hidden" value="1" /></td>
                                                <td><input type="number" /></td>
                                            </tr>
                                            <tr>
                                                <td>Cost per Sale (CPS)<input type="hidden" value="2" /></td>
                                                <td><input type="number" /></td>
                                            </tr>
                                            <tr>
                                                <td>Cost per Click (CPC)<input type="hidden" value="3" /></td>
                                                <td><input type="number" /></td>
                                            </tr>
                                            <tr>
                                                <td>Cost per Thousand Impressions (CPM)<input type="hidden" value="4" /></td>
                                                <td><input type="number" /></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>-->
                    </fieldset>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Integration</span>
                        </h6>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Clone from buyer channel")<br />
                                    @Html.DropDownList("BuyerChannelTemplateId", new List<SelectListItem>(), new { @class = "select", style = "width: 80px" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#modal_default">Load template<i class="icon-play3 position-right"></i></button>

                            <div class="table-responsive">
                                <table class="table table-bordered tree-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 46px;">#</th>
                                            <th style="width: 80px;">Template field</th>
                                            <th style="width: 80px;">Campaign field</th>
                                            <th style="width: 80px;">Default value</th>
                                            <th style="width: 80px;">Matching</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </fieldset>

                    @if (Model.AlwaysSoldOption == 0)
                    {
                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Response settings</span>
                        </h6>
                        <h5>Super Tier / Represent Tier</h5>
                        <div class="row">
                            <div class="col-md-12">
                                <select id="child_channels" multiple="multiple" class="form-control listbox-no-selection"></select>
                            </div>
                        </div>
                        <br /><br />
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    @Html.Label("Enable custom price reject")
                                    @Html.CheckBoxFor(x => x.EnableCustomPriceReject)
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group">
                                    @Html.Label("Enable dynamic values append")
                                    @Html.CheckBoxFor(x => x.FieldAppendEnabled)
                                    <br />
                                    (Dynamic values are parsed by # symbol, for example #CHANNELID# or #IPADDRESS#)<br />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group has-feedback">
                                    @Html.Label("Win response url")<br />
                                    @Html.TextBoxFor(x => x.WinResponseUrl, new { @class = "form-control", tabindex = 1, maxlength = "500" })
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group has-feedback">
                                    @Html.Label("Win response post method")<br />
                                    @Html.DropDownList("WinResponsePostMethod", Model.ListWinResponsePostMethod, new { @class = "form-control" })
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group has-feedback">
                                    @Html.Label("Lead Id field")<br />
                                    @Html.TextBoxFor(x => x.LeadIdField, new { @class = "form-control", tabindex = 1, maxlength = "50" })
                                </div>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group has-feedback">
                                    Price reject win response. Use {leadid}, {price} labels for Lead ID and PRICE dynamic replacement.<br />
                                    @Html.TextAreaFor(x => x.PriceRejectWinResponse, new { @class = "form-control", tabindex = 1 })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.AcceptedField)
                                    @Html.TextBoxFor(x => x.AcceptedField, new { @class = "form-control", tabindex = 1, placeholder = "Accepted field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.AcceptedValue)
                                    @Html.TextBoxFor(x => x.AcceptedValue, new { @class = "form-control", tabindex = 1, placeholder = "Accepted value", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.AcceptedFromField)
                                    @Html.DropDownList("AcceptedFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.ErrorField)
                                    @Html.TextBoxFor(x => x.ErrorField, new { @class = "form-control", tabindex = 1, placeholder = "Error field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.ErrorValue)
                                    @Html.TextBoxFor(x => x.ErrorValue, new { @class = "form-control", tabindex = 1, placeholder = "Error value", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.ErrorFromField)
                                    @Html.DropDownList("ErrorFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.RejectedField)
                                    @Html.TextBoxFor(x => x.RejectedField, new { @class = "form-control", tabindex = 1, placeholder = "Rejected field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.RejectedValue)
                                    @Html.TextBoxFor(x => x.RejectedValue, new { @class = "form-control", tabindex = 1, placeholder = "Rejected value", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.RejectedFromField)
                                    @Html.DropDownList("RejectedFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.TestField)
                                    @Html.TextBoxFor(x => x.TestField, new { @class = "form-control", tabindex = 1, placeholder = "Test field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.TestValue)
                                    @Html.TextBoxFor(x => x.TestValue, new { @class = "form-control", tabindex = 1, placeholder = "Test value", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.TestFromField)
                                    @Html.DropDownList("TestFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                                </div>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Price reject field")
                                    @Html.TextBoxFor(x => x.PriceRejectField, new { @class = "form-control", tabindex = 1, placeholder = "Price reject field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Price reject value")
                                    @Html.TextBoxFor(x => x.PriceRejectValue, new { @class = "form-control", tabindex = 1, placeholder = "Price reject value" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    @Html.Label("Delimeter")
                                    @Html.TextBoxFor(x => x.Delimeter, new { @class = "form-control", tabindex = 1, placeholder = "Delimeter", maxlength = "50" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.RedirectField)
                                    @Html.TextBoxFor(x => x.RedirectField, new { @class = "form-control", tabindex = 1, placeholder = "Redirect field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.MessageField)
                                    @Html.TextBoxFor(x => x.MessageField, new { @class = "form-control", tabindex = 1, placeholder = "Message field", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.PriceField)
                                    @Html.TextBoxFor(x => x.PriceField, new { @class = "form-control", tabindex = 1, placeholder = "Price field" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Field for AccountID")
                                    @Html.TextBoxFor(x => x.AccountIdField, new { @class = "form-control", tabindex = 1, placeholder = "AccountID field" })
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    }

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Schedule options</span>
                        </h6>

                        <div class="row">
                            <div class="col-md-2">
                                <button id="schedule_add" type="button" class="btn btn-default btn-sm">Add New Record</button>
                                <hr />
                                <br />
                                <b>Please note</b>: <br />If <b>schedule price</b> is higher than 0, it will always override affiliate price within the selected date range.
                                <br />
                                To ignore <b>CAP for the given period</b>, set Quantity to -1 (MINUS ONE)
                                <br />
                                To ignore <b>max hourly CAP</b> set the value to -1 (MINUS ONE)
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    @Html.Label("Daily cap")<br />
                                    @Html.TextBoxFor(x => x.DailyCap, new { @class = "form-control", tabindex = 1, placeholder = "Daily cap" })
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="schedule" class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 220px">Day</th>
                                        <th style="width: 170px">Start</th>
                                        <th style="width: 170px">Finish</th>
                                        <th>Cap</th>
                                        <th>Wait after post</th>
                                        <th>Wait after sold</th>
                                        <th>Max hourly cap</th>
                                        <th>Price</th>
                                        <th>Lead status</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var si in Model.ScheduleItems)
                                    {
                                        <tr>
                                            <td>
                                                <div class="custom-dropdown width-100-percent">
                                                    <select class="daysofweek">
                                                        <option>NONE</option>
                                                        <option @Html.Raw(si.Day == "Sunday" ? "selected" : "")>Sunday</option>
                                                        <option @Html.Raw(si.Day == "Monday" ? "selected" : "")>Monday</option>
                                                        <option @Html.Raw(si.Day == "Tuseday" ? "selected" : "")>Tuseday</option>
                                                        <option @Html.Raw(si.Day == "Wednesday" ? "selected" : "")>Wednesday</option>
                                                        <option @Html.Raw(si.Day == "Thursday" ? "selected" : "")>Thursday</option>
                                                        <option @Html.Raw(si.Day == "Friday" ? "selected" : "")>Friday</option>
                                                        <option @Html.Raw(si.Day == "Saturday" ? "selected" : "")>Saturday</option>
                                                    </select>
                                                </div>
                                            </td>
                                            <td style="width: 130px">
                                                <div class="custom-dropdown display-inline-block">
                                                    <select class="form-control fromhours">
                                                        @for (int i = 0; i <= 24; i++)
                                                        {
                                                            <option @Html.Raw((i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString()) == si.FromHour ? " selected" : "")>
                                                                @Html.Raw(i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString())
                                                            </option>
                                                        }
                                                    </select>
                                                </div>
                                                <div class="custom-dropdown display-inline-block">
                                                    <select class="form-control fromminutes">
                                                        @for (int i = 0; i <= 59; i++)
                                                        {
                                                            <option @Html.Raw((i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString()) == si.FromMinute ? " selected" : "")>
                                                                @Html.Raw(i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString())
                                                            </option>
                                                        }
                                                    </select>
                                                </div>
                                            </td>
                                            <td style="width: 130px">
                                                <div class="custom-dropdown display-inline-block">
                                                    <select class="form-control tohours">
                                                        @for (int i = 0; i <= 24; i++)
                                                        {
                                                            <option @Html.Raw((i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString()) == si.ToHour ? " selected" : "")>
                                                                @Html.Raw(i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString())
                                                            </option>
                                                        }
                                                    </select>
                                                </div>
                                                <div class="custom-dropdown display-inline-block">
                                                    <select class="form-control tominutes">
                                                        @for (int i = 0; i <= 59; i++)
                                                        {
                                                            <option @Html.Raw((i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString()) == si.ToMinute ? " selected" : "")>
                                                                @Html.Raw(i.ToString().Length == 1 ? "0" + i.ToString() : i.ToString())
                                                            </option>
                                                        }
                                                    </select>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" value="@si.Quantity">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" value="@si.PostedWait">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" value="@si.SoldWait">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" value="@si.HourMax">
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" value="@si.Price">
                                            </td>
                                            <td>
                                                <select class="form-control">
                                                    <option value="0">All</option>
                                                    <option value="1">Sold</option>
                                                    <option value="3">Rejected</option>
                                                </select>
                                            </td>
                                            <td>
                                                <div class="schedule_remove">
                                                    <i class="glyphicon glyphicon-remove red"></i>
                                                </div>
                                                <div>
                                                    <a href="#" class="clone-schedule-row">Clone</a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </fieldset>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Filter settings</span>
                        </h6>

                        <span style="font-size: 14px"><b>Age filter</b></span><br />
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    @Html.Label("Min age")
                                    @Html.TextBoxFor(x => x.MinAgeTargeting, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "", required = "" })
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    @Html.Label("Max age")
                                    @Html.TextBoxFor(x => x.MaxAgeTargeting, new { @class = "form-control", type = "number", tabindex = 1, placeholder = "", required = "" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-1">
                                <select id="filter_templates" class="form-control">
                                    <option value="0">Select a set</option>
                                    @foreach (var f in Model.Filters)
                                    {
                                        <option value="@f.Id">@f.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button id="filter_add" type="button" class="btn btn-default btn-sm">Add filter</button>
                            </div>
                        </div>
                        <table id="conditions" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th width="10%">Field</th>
                                    <th width="15%">Condition</th>
                                    <th width="73%">Value</th>
                                    <td width="2%"></td>
                                    <td width="2%"></td>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </fieldset>

                    <div style="color:red">
                        @Html.ValidationSummary()
                    </div>

                    <div class="form-wizard-actions">
                        @Html.HiddenFor(x => x.BuyerChannelId)
                        @Html.HiddenFor(x => x.CampaignType)
                        @Html.HiddenFor(x => x.AfterTimeout)
                        <input class="btn btn-default" id="validation-back" value="Back" type="reset">
                        <input class="btn btn-info" id="validation-next" value="Next" type="submit">
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Basic modal -->
<div id="modal_default" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">Template</h5>
            </div>

            <div class="modal-body">
                <textarea id="xml_template" class="form-control" rows="15"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
                <button id="load_template_btn" type="button" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>
</div>

<div id="modal_blacklist_value" class="modal fade">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <label>Add value</label><br />
                <input id="new_blacklist_value" name="new_blacklist_value" /><button id="add_new_blacklist_value">Add</button><br /><br />

                <div id="blacklist_values">
                    <div id="blacklist_values"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- /basic modal -->

<div id="matching_values_modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">Template</h5>
            </div>

            <div class="modal-body">
                <label>Add new</label><br />
                <table>
                    <tr>
                        <td>
                            <input type="text" id="inputValue" class="form-control" placeholder="Input value" style="width: 100%" />
                        </td>
                        <td>
                            <input type="text" id="outputValue" class="form-control" placeholder="Output value" style="width: 100%" />
                        </td>
                        <td>
                            <button id="addMatchingBtn" style='height:36px'>Add</button>
                        </td>
                    </tr>
                </table>

                <br /><br />
                <div class="table-responsive">
                    <table id="matching_values">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Input value</th>
                                <th style="width: 80px;">Output value</th>
                                <th style="width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="matchingModalSave" type="button" class="btn btn-success" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

    <fieldset class="step" id="step4-tpl" style="display: none">

        <h6 class="form-wizard-title text-semibold">
            <span class="form-wizard-count">4</span>
            <span>Response settings</span>
        </h6>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.AcceptedField)
                    @Html.TextBoxFor(x => x.AcceptedField, new { @class = "form-control", tabindex = 1, placeholder = "Accepted field" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.AcceptedValue)
                    @Html.TextBoxFor(x => x.AcceptedValue, new { @class = "form-control", tabindex = 1, placeholder = "Accepted value" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.AcceptedFromField)
                    @Html.DropDownList("AcceptedFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.ErrorField)
                    @Html.TextBoxFor(x => x.ErrorField, new { @class = "form-control", tabindex = 1, placeholder = "Error field" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.ErrorValue)
                    @Html.TextBoxFor(x => x.ErrorValue, new { @class = "form-control", tabindex = 1, placeholder = "Error value" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.ErrorFromField)
                    @Html.DropDownList("ErrorFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.RejectedField)
                    @Html.TextBoxFor(x => x.RejectedField, new { @class = "form-control", tabindex = 1, placeholder = "Rejected field" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.RejectedValue)
                    @Html.TextBoxFor(x => x.RejectedValue, new { @class = "form-control", tabindex = 1, placeholder = "Rejected value" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.RejectedFromField)
                    @Html.DropDownList("RejectedFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.TestField)
                    @Html.TextBoxFor(x => x.TestField, new { @class = "form-control", tabindex = 1, placeholder = "Test field" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.TestValue)
                    @Html.TextBoxFor(x => x.TestValue, new { @class = "form-control", tabindex = 1, placeholder = "Test value" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.TestFromField)
                    @Html.DropDownList("TestFromField", Model.ListFromFieldType, new { @class = "select", style = "width: 100px" })
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.RedirectField)
                    @Html.TextBoxFor(x => x.RedirectField, new { @class = "form-control", tabindex = 1, placeholder = "Redirect field", required = "required" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.MessageField)
                    @Html.TextBoxFor(x => x.MessageField, new { @class = "form-control", tabindex = 1, placeholder = "Message value", required = "required" })
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    @Html.LabelFor(x => x.PriceField)
                    @Html.TextBoxFor(x => x.PriceField, new { @class = "form-control", tabindex = 1, placeholder = "Price value", required = "required" })
                </div>
            </div>
        </div>
    </fieldset>