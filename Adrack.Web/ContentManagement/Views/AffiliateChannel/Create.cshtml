@model Adrack.Web.ContentManagement.Models.Lead.AffiliateChannelModel

@using Adrack.Service.Helpers

@{
    Html.AddPageTitle(T("PageTitle.Register").Text);

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/core.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/interactions.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/effects.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jquery_ui/interactions.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/uniform.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/blockui.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/trees/fancytree_all.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/trees/fancytree_childcounter.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/form.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/form.wizard.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/select2.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/library/jasny.bootstrap.min.js").ToLowerInvariant());
    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/validate.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/plugins/ui/moment/moment.min.js").ToLowerInvariant());

    Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/ContentManagement/Scripts/plugins/notifications/pnotify.min.js").ToLowerInvariant());

    //Html.AppendPageScript(PageLayoutPosition.Body, string.Format("~/Scripts/core/domain/membership/register.js").ToLowerInvariant());
    Html.AppendPageCustom(PageLayoutPosition.ContainerAttribute, "login-container");

    var currentUser = this.AppContext.AppUser;
    var stepIndex = 1;
}

<style>
    .invalid-filter-value {
        color: red;
    }
</style>

<script type="text/javascript">

    var campaignFields = [];
    var campaignType = 0;
    var filterRowNum = 0;

   function campaignTemplateChange(e) {
       var defaultValue = '';

        for (var i = 0; i < fieldsSelect.length; i++) {
            if (fieldsSelect[i].id == $(e).val()) {

                try {
                    $(e).parent().parent().children('td').eq(2).html('<textarea class="first-value form-control" style="resize: none; height: 36px;" data-validatorvalue="' + fieldsSelect[i].validatorValue + '" data-validator="' + fieldsSelect[i].validator + '">' + defaultValue + '</textarea>');
                }
                catch (ex) {
                    $(e).parent().parent().children('td').eq(2).html('<textarea class="first-value form-control" style="resize: none; height: 36px;" data-validatorvalue="' + fieldsSelect[i].validatorValue + '" data-validator="' + fieldsSelect[i].validator + '">' + defaultValue + '</textarea>');
                }

                break;
            }
        }
    }

    function allowedChanged(e)
    {
        $.ajax({
            type: "POST",
            url: "@(Url.RouteUrl("updateallowed"))",
            data: { aid: affiliateChannelId, bid: $(e).data('id'), add: $(e).is(':checked') },
            success: function (data) {
                //$(this).parent('td').parent('tr').remove();
                GenerateGridTable("blacklist_values", "/GetCustomBlackListValues?id=@Model.AffiliateChannelId&type=1&field=" + curTemplateField, "ID, Value, Action", null, null, null, null);
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function value_remove(e)
    {
        $.ajax({
            type: "POST",
            url: "@(Url.RouteUrl("removecustomblacklistvalue"))",
            data: { id: $(e).data('id') },
            success: function (data) {
                //$(this).parent('td').parent('tr').remove();
                GenerateGridTable("blacklist_values", "/GetCustomBlackListValues?id=@Model.AffiliateChannelId&type=1&field=" + curTemplateField, "ID, Value, Action", null, null, null, null);
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function BlackListDialog(e) {
        curTemplateField = $(e).data('field');
        $('#modal_blacklist_value').modal('show');
        GenerateGridTable("blacklist_values", "/GetCustomBlackListValues?id=@Model.AffiliateChannelId&type=1&field=" + curTemplateField, "ID, Value, Action", null, null, null, null);
    }

    function generate_password(e)
    {
        if (!confirm('Are you sure?')) return;
        var randomstring = Math.random().toString(36).slice(-8);
        $(e).parent().children('input').val(randomstring);
    }

 function addFilterRow(field, condition, value, operator, parentid = 0, existing = false) {

        var addChildBtn = '';
        var subIcon = '';
        var forsubselect = '';

        if (parentid == 0) {
            filterRowNum++;
            addChildBtn = '<div class="add_child_btn" data-id="' + filterRowNum + '"><i class="glyphicon glyphicon-plus-sign green"></i></div>';
        } else {
            subIcon = '<div class="subitem-ico"><i class="glyphicon glyphicon-chevron-right"></i></div>';
            forsubselect = 'forsubselect';
        }

        var html = '<tr class="row_' + filterRowNum + '">';
        html += '<td>';
        html += subIcon;

        html += '<select class="fields form-control ' + forsubselect + '" data-id="' + filterRowNum + '" data-parent-id="'+ parentid +'" style="width: 400px"  onchange="campaignTemplateChange(this)">';
        var selected = '';
        if (fieldsSelect.length == 0)
        {
            @foreach(var t in Model.CampaignTemplate)
            {
                @Html.Raw("selected = ''; if (field == " + t.Id.ToString() + ") selected = 'selected';");
                @Html.Raw("html += '<option value=\"" + t.Id.ToString() + "\" ' + selected +'>" + t.TemplateField + "</option>';");

                @Html.Raw("fieldsSelect.push({ id: " + t.Id.ToString() + ", name: '" + t.TemplateField + "', filterSettings: '" + (!string.IsNullOrEmpty(t.FieldFilterSettings) ? t.FieldFilterSettings.Replace("\r", "").Replace("\n", "").Replace("\t", "") : "") + "', validatorValue:'" + (!string.IsNullOrEmpty(t.ValidatorValue) ? t.ValidatorValue : "") + "', validator: '" + t.Validator.ToString() + "' });");
            }
        }
        else
        {
            $.each(fieldsSelect, function (id, option) {
                selected = '';
                if (option.id == field) selected = 'selected';
                html += '<option value="' + option.id + '" ' + selected +'>' + option.name + "</option>";
            });
        }

        html += '</select>';
        html += '</td>';
        html += '<td>';
        html += '<select class="form-control">';
        html += '<option value="1" ' + (condition == '1' ? ' selected' : '') + '>CONTAINS</option>';
        html += '<option value="2" ' + (condition == '2' ? ' selected' : '') + '>DOES NOT CONTAIN</option>';
        html += '<option value="3" ' + (condition == '3' ? ' selected' : '') + '>STARTS WITH</option>';
        html += '<option value="4" ' + (condition == '4' ? ' selected' : '') + '>ENDS WITH</option>';
        html += '<option value="5" ' + (condition == '5' ? ' selected' : '') + '>EQUAL</option>';
        html += '<option value="6" ' + (condition == '6' ? ' selected' : '') + '>NOT EQUAL</option>';
        html += '<option value="7" ' + (condition == '7' ? ' selected' : '') + '>GREATER</option>';
        html += '<option value="8" ' + (condition == '8' ? ' selected' : '') + '>GREATER EQUAL</option>';
        html += '<option value="9" ' + (condition == '9' ? ' selected' : '') + '>LESS</option>';
        html += '<option value="10" ' + (condition == '10' ? ' selected' : '') + '>LESS EQUAL</option>';
        html += '<option value="11" ' + (condition == '11' ? ' selected' : '') + '>RANGE</option>';
        html += '<option value="12" ' + (condition == '12' ? ' selected' : '') + '>NO SAME DIGITS</option>';
        html += '</select>';
        html += '</td>';

        html += '<td>';
        html += '<textarea class="form-control first-value" style="resize: none; height: 36px;">' + value + '</textarea>';
        html += '</td>';

        html += '<td><div class="filter_remove"><i class="glyphicon glyphicon-remove red"></i></div></td>';
        html += '<td>' + addChildBtn + '</td>';
        html += '</tr>';


        if (parentid == 0) {
            $('#conditions tbody').append(html);
        } else {
            if (!existing)
                $(html).insertAfter($(".row_" + parentid).last());
            else
                $(html).insertAfter($(".row_" + filterRowNum).last());
        }

        $('.filter_remove').off('click').on('click', function () {
            $(this).parent().parent().remove();
        });
    }

    function addBlRow(field, value, operator)
    {
        var html = '<tr>';
        html += '<td>';
        html += '<select class="fields form-control" style="width: 400px">';
        var selected = '';
        if (fieldsSelect.length == 0)
        {
            @foreach(var t in Model.CampaignTemplate)
            {
                @Html.Raw("selected = ''; if (field == " + t.Id.ToString() + ") selected = 'selected';");
                @Html.Raw("html += '<option value=\"" + t.Id.ToString() + "\" ' + selected +'>" + t.TemplateField + "-" + t.Description + "</option>';");
            }
        }
        else
        {
            $.each(fieldsSelect, function (id, option) {
                selected = '';
                if (option.id == field) selected = 'selected';
                html += '<option value="' + option.id + '" ' + selected +'>' + option.name + "</option>";
            });
        }
        html += '</select>';
        html += '</td>';

        html += '<td>';

        html += '<textarea class="form-control" style="resize: none;">' + value + '</textarea>';
        html += '</td>';

        html += '<td><div class="bl_remove"><i class="glyphicon glyphicon-remove red"></i></div></td>';
        html += '</tr>';

        $('#blacklist tbody').append(html);

        $('.bl_remove').off('click').on('click', function () {
            $(this).parent().parent().remove();
        });
    }

    function editRow()
    {
        if (selectedNode == null)
        {
            alert('Please select the node');
            return;
        }

        editMode = true;

        $('#node_name').val(selectedNode.title);

        $('#modal_add_node').modal('show');
    }

    function deleteRow()
    {
        if (selectedNode == null)
        {
            alert('Please select the node');
            return;
        }

        selectedNode.remove();
    }

    function loadTree(source)
    {
        var tree = $('.tree-table').fancytree('getTree');
        tree.reload(source);

        $(".fancytree-container tr td:first-child").hide();
        $(".fancytree-container tr th:first-child").hide();
    }

    function GetXml()
    {
        tpl = [];

        var tree = $(".tree-table").fancytree("getTree");
        tpl = getNodes(tree, tree.rootNode, "root", tpl);

        var tpljson = JSON.stringify(tpl);

        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("GetAffiliateChannelXml"))",
            data: { xml: xmlTpl, json: tpljson },
            success: function (data) {
                $('#xmltopost').val(data.xml);

            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function initTree()
    {
        $(".tree-table").fancytree({
            extensions: ["table", "dnd"],
            checkbox: true,
            keyboard: false,
            table: {
                indentation: 20,      // indent 20px per node level
                nodeColumnIdx: 1,     // render the node title into the 2nd column
                checkboxColumnIdx: 0  // render the checkboxes into the 1st column
            },
            source: [],
            lazyLoad: function (event, data) {
                data.result = { url: "ajax-sub2.json" }
            },
            renderColumns: function (event, data) {
                var node = data.node,
                $tdList = $(node.tr).find(">td");

                $(node.tr).data('folder', node.folder);

                $tdList.eq(0).data('name', "n");
                $tdList.eq(1).data('name', "campaign field");
                $tdList.eq(2).data('name', "template field");
                $tdList.eq(3).data('name', "default value");
                if (@Model.AffiliateChannelId > 0)
                {
                    //$tdList.eq(4).data('name', "black list value");
                }
                /* $tdList.eq(1).data('value', node.parent.title);
                 $tdList.eq(2).data('value', node.data.DatabaseField);
                 $tdList.eq(3).data('value', node.data.Validator);
                 $tdList.eq(5).data('value', node.data.Required);*/

                // (index #0 is rendered by fancytree by adding the checkbox)

                if (!node.folder)
                {
                    var sel = '';

                    var templateField = '<select class="cmp form-control" style="width: 150px">';

                    @foreach (var item in Model.ListCampaignField)
                    {
                        @Html.Raw("if (node.data.CampaignTemplateId == " + item.Value + ") { sel = 'selected'; } else { sel = ''; }");
                        @Html.Raw("templateField += '<option value=\"" + item.Value + "\" ' + sel + '>" + item.Text + "</option>';")
                    }

                    templateField += '</select>';

                    $tdList.eq(2).addClass('text-center').html(templateField);

                    @if (currentUser.UserTypeId == SharedData.BuiltInUserTypeId || currentUser.UserTypeId == SharedData.NetowrkUserTypeId)
                    {
                        @: $tdList.eq(3).addClass('text-center').html("<input type='text' class='form-control'  maxlength='150' name='default_value' value='" + node.data.DefaultValue + "'>" + (node.title.toLowerCase() == "password" ? "<br><a onclick='generate_password(this)' href='javascript:void(0)'>Generate</a>" : ""));
                                                            }
                    else
                    {
                        @: $tdList.eq(3).addClass('text-center').html("<input type='text' class='form-control' maxlength='150' name='default_value' value='" + node.data.DefaultValue + "' readonly>" + (node.title.toLowerCase() == "password" ? "<br><a onclick='generate_password(this)' href='javascript:void(0)'>Generate</a>" : ""));
                                                            }

                    if (@Model.AffiliateChannelId > 0)
                    {
                        //$tdList.eq(4).addClass('text-center').html('<a href="javascript:void(0)" data-field="' + node.title + '" onclick="BlackListDialog(this)" class="btn-blacklist">Black lists</a>');
                    }

                    // Style checkboxes
                    $(node.tr).find(".styled").uniform({ radioClass: 'choice' });

                    FillCampaignDropdown($(node.tr).find(".cmp"), node.title);

                    //$(node.tr).find(".cmp").select2();
                }

                //$(".cm").off("select2:select").on("select2:select", function (e) { $(this).parent().data('value', e.params.data.id); console.log(e); });
            },
            activate: function(event, data) {
                selectedNode = data.node;
            },
            select: function(event, data) {
                console.log(data);
                // Display list of selected nodes
                //var s = data.tree.getSelectedNodes().join(", ");
                //$("#echoSelection1").text(s);
            },
            dnd: {
                preventVoidMoves: true, // Prevent dropping nodes 'before self', etc.
                preventRecursiveMoves: true, // Prevent dropping nodes on own descendants
                autoExpandMS: 400,
                draggable: {
                    //zIndex: 1000,
                    // appendTo: "body",
                    // helper: "clone",
                    scroll: false,
                    revert: "invalid"
                },
                dragStart: function (node, data) {
                    if (data.originalEvent.shiftKey) {
                        console.log("dragStart with SHIFT");
                    }
                    // allow dragging `node`:
                    return true;
                },
                dragEnter: function (node, data) {
                    // Prevent dropping a parent below another parent (only sort
                    // nodes under the same parent)
                    /* 					if(node.parent !== data.otherNode.parent){
                                            return false;
                                        }
                                        // Don't allow dropping *over* a node (would create a child)
                                        return ["before", "after"];
                    */
                    return true;
                },
                dragDrop: function (node, data) {
                    if (!data.otherNode) {
                        // It's a non-tree draggable
                        var title = $(data.draggable.element).text() + " (" + (count)++ + ")";
                        node.addNode({ title: title }, data.hitMode);
                        alert('dd');
                        return;
                    }
                    data.otherNode.moveTo(node, data.hitMode);
                    $(node.tr).data('folder', true);
                    console.log(node.tr);
                }
            }
        });
    }

    function LoadAChannelTemplate(achannelid)
    {
        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("LoadAffiliateChannelTemplate"))",
            data: { achannelid: achannelid, xml: $('#xml_template').val() },
            success: function (data) {
                GetXml();
                loadTree(data);

                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function LoadCampaignTemplate(campaignid)
    {
        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("loadcampaigntemplatelist"))",
            data: { campaignid: campaignid },
            success: function (data) {
                campaignFields = [];
                $.each(data, function (id, option) {
                    campaignFields.push({ id: option.id, name: option.name});
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function FillCampaignDropdown(e, campaigntemplateid)
    {
        $(e).html('');
        $(e).append($('<option></option>').val(0).html("NONE").attr('selected', true));
        $.each(campaignFields, function (id, option) {
            if (option.name != campaigntemplateid)
            {
                $(e).append($('<option></option>').val(option.id).html(option.name).removeAttr('selected'));
            }
            else
            {
                $(e).find('option').removeAttr('selected');
                $(e).append($('<option></option>').attr('selected', true).val(option.id).html(option.name));
            }
        });
    }

    function getNodes(tree, parent, parentName, ar)
    {
        if (tree == undefined || parent == undefined) return ar;

        if (parent.children != null)
        {
            if (parent.children.length > 0 && parent.title != parentName)
            {
                ar.push([]);

                ar[ar.length - 1].push(parent.title);
                ar[ar.length - 1].push("0");
                ar[ar.length - 1].push("");
                ar[ar.length - 1].push(parentName);
            }

            for(var i = 0; i < parent.children.length; i++)
            {
                if (parent.children[i].children == null || parent.children[i].children.length == 0)
                {
                    ar.push([]);

                    $(parent.children[i].tr).children('td').each(function () {
                        var value = null;

                        if ($(this).data('name') == "campaign field") {
                            value = $(this).find(".fancytree-title").text();
                            console.log(value);
                        }
                        else
                            if ($(this).data('name') == "template field") {
                                value = $(this).find("select").val();
                            }
                            else
                                if ($(this).data('name') == "default value") {
                                    value = $(this).find("input").val();
                                }

                        if (value != null)
                            ar[ar.length - 1].push(value);
                    });

                    ar[ar.length - 1].push(parent.title);
                }
                else
                    ar = getNodes(tree, parent.children[i], parent.title, ar);
            }
        }

        return ar;
    }

    function addNodeDialog()
    {
        editMode = false;
        $('#modal_add_node').modal('show');
    }

    function LoadCampaignXml(selectedItem)
    {
        $.ajax({
            cache: false,
            async: false,
            type: "POST",
            url: "@(Url.RouteUrl("LoadFromCampaignXml"))",
            data: { campaignid: selectedItem },
            success: function (data) {
                xmlTpl = data.xml;
                LoadCampaignTemplate(selectedItem);
                loadTree(data.items);

                $("#@Html.FieldIdFor(x => x.MinPriceOptionValue)").val(data.targetRevenue);
                $("#@Html.FieldIdFor(x => x.MinRevenue)").val(data.minimumRevenue);

                $('.cmp').each(function ()
                {
                    var text = $(this).parent().parent().find('.fancytree-title').text();
                    $(this).find('option:contains(' + text + ')').each(function(){
                        if ($(this).text() == text) {
                            $(this).attr('selected', 'selected');
                            return false;
                        }
                        return true;
                    });
                    $(this).change();
                });

                $('.modal-body').unblock();
                $('#modal_default').modal('hide');
                //setTimeout(function () { $('#modal_default').hide(); }, 500);
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function formatXml(xml) {
        var formatted = '';
        var reg = /(>)(<)(\/*)/g;
        xml = xml.replace(reg, '$1\r\n$2$3');
        var pad = 0;
        jQuery.each(xml.split('\r\n'), function(index, node) {
            var indent = 0;
            if (node.match( /.+<\/\w[^>]*>$/ )) {
                indent = 0;
            } else if (node.match( /^<\/\w/ )) {
                if (pad != 0) {
                    pad -= 1;
                }
            } else if (node.match( /^<\w[^>]*[^\/]>.*$/ )) {
                indent = 1;
            } else {
                indent = 0;
            }

            var padding = '';
            for (var i = 0; i < pad; i++) {
                padding += '  ';
            }

            formatted += padding + node + '\r\n';
            pad += indent;
        });

        return formatted;
    }

    var step2Clone = null;
    var step3Clone = null;

    $(function () {

        $(".form-validation").formwizard({
            disableUIStyles: true,
            validationEnabled: true,
            inDuration: 150,
            outDuration: 150,
            validationOptions: {
                ignore: 'input[type=hidden], .select2-search__field',
                errorClass: 'validation-error-label',
                successClass: 'validation-valid-label',
                highlight: function (element, errorClass) {
                    $(element).removeClass(errorClass);
                },
                unhighlight: function (element, errorClass) {
                    $(element).removeClass(errorClass);
                },

                // Different components require proper error label placement
                errorPlacement: function (error, element) {

                    // Styled checkboxes, radios, bootstrap switch
                    if (element.parents('div').hasClass("checker") || element.parents('div').hasClass("choice") || element.parent().hasClass('bootstrap-switch-container')) {
                        if (element.parents('label').hasClass('checkbox-inline') || element.parents('label').hasClass('radio-inline')) {
                            error.appendTo(element.parent().parent().parent().parent());
                        }
                        else {
                            error.appendTo(element.parent().parent().parent().parent().parent());
                        }
                    }
                        // Unstyled checkboxes, radios
                    else if (element.parents('div').hasClass('checkbox') || element.parents('div').hasClass('radio')) {
                        error.appendTo(element.parent().parent().parent());
                    }

                        // Input with icons and Select2
                    else if (element.parents('div').hasClass('has-feedback') || element.hasClass('select2-hidden-accessible')) {
                        error.appendTo(element.parent());
                    }

                        // Inline checkboxes, radios
                    else if (element.parents('label').hasClass('checkbox-inline') || element.parents('label').hasClass('radio-inline')) {
                        error.appendTo(element.parent().parent());
                    }

                        // Input group, styled file input
                    else if (element.parent().hasClass('uploader') || element.parents().hasClass('input-group')) {
                        error.appendTo(element.parent().parent());
                    }

                    else {
                        error.insertAfter(element);
                    }
                },
                rules: {
                    Email: {
                        email: true
                    },
                    MinPriceOptionValue: {
                        number: true
                    },
                    MinRevenue: {
                        number: true
                    },
                    Password: {
                        minlength: 8
                    },
                    ConfirmPassword: {
                        minlength: 8,
                        equalTo: "#Password"
                    }
                }
            }
        });

        $('.filter_remove').off('click').on('click', function () {
            $(this).parent().parent().remove();
        });

        $('.bl_remove').off('click').on('click', function () {
            $(this).parent().parent().remove();
        });

        $('#add_new_blacklist_value').click(function () {
            if (curTemplateField == '') return;
            var v = $('#new_blacklist_value').val();
            $('#new_blacklist_value').val('');
            $.ajax({
                type: "POST",
                url: "@(Url.RouteUrl("addcustomblacklistvalue"))",
                data: { id: @Model.AffiliateChannelId, type: 1, value: v, field: curTemplateField },
                success: function (data) {
                    GenerateGridTable("blacklist_values", "/GetCustomBlackListValues?id=@Model.AffiliateChannelId&type=1&field=" + curTemplateField, "ID, Value, Action", null, null, null, null);
                    //setTimeout(function () { $('#modal_default').hide(); }, 500);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                }
            });
            return false;
        });

        $('.btn-blacklist').click(function () {
            curTemplateField = $(this).data('field');
            $('#modal_blacklist_value').modal('show');
            GenerateGridTable("blacklist_values", "/GetCustomBlackListValues?id=@Model.AffiliateChannelId&type=1&field=" + curTemplateField, "ID, Value, Action", null, null, null, null);
        });

        $("#XmlTemplateText").text( formatXml($("#XmlTemplateText").text() ) );

        $('#filter_templates').on('change', function (e) {
            var selectedItem = $(this).val();
            if (selectedItem == 0) return;

            if (!confirm('Are you sure you want to apply the filter template?')) {
                e.preventDefault();
                return;
            }
            $.ajax({
                cache: false,
                type: "POST",
                url: "/getfilterconditions",
                data: { filterid: selectedItem },
                success: function (data) {
                    $('#conditions tbody').html('');
                    $.each(data, function (id, option) {
                        console.log(option);
                        addFilterRow(option.field, option.condition, option.value, option.op, option.parent);
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });
        });

        $('#filter_add').click(function () {
            addFilterRow(0, '0', '', '0', 0);
        });

        $('#bl_add').click(function () {
            addBlRow(0, '', '', '0');
        });

        /*$("#MinPriceOption").change(function () {
            var selectedItem = parseInt($(this).val());

            $('#value_div').css('opacity', '1');
            $('#revenue_div').css('opacity', '1');
            $('#option_value').text('Value');

            switch(selectedItem)
            {
                case 0:
                    $('#value_div').css('opacity', '0');
                    $('#revenue_div').css('opacity', '0');
                    $("#MinPriceOptionValueDescription").text('Affiliate receives amount equal to his MinPrice, if it is less or equal to Affiliateprice in Buyer channel'); break;
                case 1:
                    $('#revenue_div').css('opacity', '0');
                    $("#MinPriceOptionValueDescription").text('For all sold leads Minprice is less or equeal to Buyer channel Affiliate price and Affiliate receives fixed amount specified  here'); break;
                case 2:
                    $('#option_value').text('Affiliate share%');
                    $("#MinPriceOptionValueDescription").text('Affiliate receives appropriate commission from the Buyer Channel’s Buyer Price but not less than minimum revenue.'); break;
                case 3:
                    $('#revenue_div').css('opacity', '0');
                    $("#MinPriceOptionValueDescription").text('Fixed amount that should be granted to the network from any sold lead. MinPrice+Fixed commision<=Buyer price in Buyer channel'); break;
                case 4:
                    $('#revenue_div').css('opacity', '0');
                    $("#MinPriceOptionValueDescription").text('Affiliate receives amount equal to Affiliate price in Buyer channel even MinPrice is less than Affiliate price in Buyer channel (Minprice<=Affiliate price in Buyer channel)'); break;
            }
        });*/

        $("#@Html.FieldIdFor(x => x.CampaignId)").change(function () {
            var selectedItem = $(this).val();
            if (selectedItem > 0)
            {
                LoadCampaignXml(selectedItem);
            }

            $.ajax({
                cache: false,
                async: false,
                type: "POST",
                url: "/GetCampaignInfo",
                data: { campaignid: selectedItem },
                success: function (data) {
                    campaignType = data.CampaignType;

                    $("#@Html.FieldIdFor(x => x.MinPriceOptionValue)").val(data.NetworkTargetRevenue);
                    $("#@Html.FieldIdFor(x => x.MinRevenue)").val(data.NetworkMinimumRevenue);

                    @if (currentUser.UserTypeId == SharedData.NetowrkUserTypeId || currentUser.UserTypeId == SharedData.BuiltInUserTypeId)
                        {
                            @:if (data.CampaignType == 1) {
                                @: step2Clone = $('#step2').clone(true);
                                @: $('#step2').remove();
                                @: step3Clone = $('#step3').clone(true);
                                @: $('#step3').remove();
                            @:}
                            @:else
                            @:{
                                @:if (step2Clone != null && step2Clone != undefined)
                                @:{
                                    @: step2Clone.insertAfter('#step1');
                                    @: step2Clone = null;
                                @:}
                                @:if (step3Clone)
                                @:{
                                   @: step3Clone.insertAfter('#step2');
                                    @:step3Clone = null;
                               @: }
                            @:}
                        @:$(".form-validation").formwizard("update_steps");
                    }

                    /*$('.cmp').each(function (){
                        console.log($(this), data.CampaignType);
                        if (data.CampaignType == 1)
                            $(this).attr('disabled', 'disabled');
                        else
                            $(this).removeAttr('disabled');
                    });*/

                    var stepCount = 1;

                    $('.form-wizard-count').each(function (){
                        $(this).text(stepCount);
                        stepCount++;
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });

            $.ajax({
                cache: false,
                type: "POST",
                url: "/GetFiltersByCampaignId",
                data: { campaignid: selectedItem },
                success: function (data) {
                    $('#filter_templates').html('');
                    $('#filter_templates').append($('<option></option>').val(0).html('Select a set'));
                    $.each(data, function (id, option) {
                        $('#filter_templates').append($('<option></option>').val(option.id).html(option.name));
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });

            $.ajax({
                cache: false,
                type: "POST",
                url: "/GetCampaignFields",
                data: { campaignid: selectedItem },
                success: function (data) {
                    var html = '<select class="fields form-control">';
                    fieldsSelect = [];
                    $.each(data, function (id, option) {
                        fieldsSelect.push({ id: option.id, name: option.name, validatorValue: option.validatorValue, validator: option.validator });
                        html += '<option value="' + option.id + '">' + option.name + "</option>";
                    });
                    html += '</select>';
                    $('#conditions tbody tr').children('td').eq(0).html(html);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert('Failed to retrieve user email.');
                }
            });
        });

        $('.select').select2();

        $('#btnSubmitClose').on('click', function () {
            canRedirect = true;
            return true;
        });

        $('#item-form').on('submit', function (e) {
            e.preventDefault();

            var disabledElements = $(this).find(':disabled');
            disabledElements.removeAttr('disabled');

            var form = $(this);

            var submitBtn = form.find(':submit');
            submitBtn.attr('disabled','disabled');

            var btn = $(":input[type=submit]:focus");

            $('#tab-main').trigger('click');

            var tpl = [];

            var sn = null;
            var lastsn = "";
            var canContinue = true;

            var conditions = [];

            $('#conditions tbody tr').each(function () {
                var field = $(this).children('td').eq(0).children('select').val();
                var condition = $(this).children('td').eq(1).children('select').val();
                var value = $(this).children('td').eq(2).children('.first-value').val();
                var validator = $(this).children('td').eq(2).children('.first-value').data('validator');
                var validatorValue = $(this).children('td').eq(2).children('.first-value').data('validatorvalue');
                var parent = $(this).children('td').eq(0).children('select').data('parent-id');
                var operator = 0;

                                var us = new RegExp("^\\d{5}(-{0,1}\\d{4})?$");
                var ca = new RegExp(/([ABCEGHJKLMNPRSTVXY]\d)([ABCEGHJKLMNPRSTVWXYZ]\d){2}/i);
                $(this).children('td').eq(2).children('.invalid-filter-value').remove();

                if (Array.isArray(value)) {
                    var val = '';
                    for (var i = 0; i < value.length; i++) {
                        val += value[i];
                        if (validator == 7) {
                            if (validatorValue == 'us' && !us.test(value[i].trim()) || validatorValue == 'ca' && !ca.test(value[i].trim())) {
                                $(this).children('td').eq(2).append('<span class="invalid-filter-value"><b>Invalid zip code</b></span>');
                                canContinue = false;
                                break;
                            }
                        }
                        if (i < value.length - 1)
                            val += ",";
                    }
                    value = val;
                }
                else if (value != null && value != undefined) {
                    var values = value.split(",");
                    for (var i = 0; i < values.length; i++) {
                        if (validator == 7) {
                            if (validatorValue == 'us' && !us.test(values[i].trim()) || validatorValue == 'ca' && !ca.test(values[i].trim())) {
                                $(this).children('td').eq(2).append('<span class="invalid-filter-value"><b>Invalid zip code</b></span>');
                                canContinue = false;
                                break;
                            }
                        }
                    }
                }

                conditions.push({ field: field, condition: condition, value: value, operator: operator, parent: parent });
            });

            if (!canContinue) {
                submitBtn.removeAttr('disabled');
                return;
            }

            var conditionsjson = JSON.stringify(conditions);

            var blacklists = [];

            $('#blacklist tbody tr').each(function () {
                var field = $(this).children('td').eq(0).children('select').val();
                var value = $(this).children('td').eq(1).children('textarea').val();
                var operator = 0;

                blacklists.push({ field: field, value: value });
            });

            var blacklistsjson = JSON.stringify(blacklists);

            tpl = [];

            if (campaignType == 0)
            {
                var tree = $(".tree-table").fancytree("getTree");
                tpl = getNodes(tree, tree.rootNode, "root", tpl);

                if (tpl.length == 0)
                {
                    alert('Affiliate channel template is not defined');
                    return;
                }
            }

            var tpljson = JSON.stringify(tpl);

            ShowLoader();

            $.ajax({
                url: $(this).attr('action'),
                type: "POST",
                async: true,
                data: $(this).serialize() + '&json=' + tpljson + '&xml=' + xmlTpl + '&conditions=' + conditionsjson + '&blacklists=' + blacklistsjson,
                success: function (data) {
                    HideLoader();
                    NotificationPopup('Success', 'Affiliate channel successfully saved');

                    if (data.error != undefined)
                    {
                        submitBtn.removeAttr('disabled');
                        alert(data.error);
                    }
                    else
                    {
                        window.location = '/management/affiliatechannel/item/' + data.id;
                    }

                    disabledElements.attr('disabled', 'disabled');
                },
                error: function (jXHR, textStatus, errorThrown) {
                    HideLoader();
                    disabledElements.attr('disabled', 'disabled');
                }
            });

            return false;
        });

        initTree();

        $('#load_template_btn').click(function () {

            $('.modal-body').block({
                message: '<i class="icon-spinner2 spinner"></i>',
                overlayCSS: {
                    backgroundColor: '#1B2024',
                    opacity: 0.85,
                    cursor: 'wait'
                },
                css: {
                    border: 0,
                    padding: 0,
                    backgroundColor: 'none',
                    color: '#fff'
                }
            });

            xmlTpl = $('#xml_template').val();

            $.ajax({
                cache: false,
                type: "POST",
                url: "@(Url.RouteUrl("LoadFromAffiliateChannelXml"))",
                data: { xml: $('#xml_template').val() },
                success: function (data) {
                    xmlTpl = data.xml;
                    GetXml();
                    loadTree(data.items);
                    $('.modal-body').unblock();
                    $('#modal_default').modal('hide');
                    //setTimeout(function () { $('#modal_default').hide(); }, 500);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                }
            });
        });

        @if (Model.CampaignId != 0)
        {
            @: $("#@Html.FieldIdFor(x => x.CampaignId)").trigger('change');
        }
    }).on("click", ".add_child_btn", function () {
        addFilterRow(0, '0', '', '', $(this).data('id'));
    });;
</script>

@using (Html.BeginForm("Item", null, FormMethod.Post, new { @class = "form-validation", id="item-form" }))
{
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="col-lg-12">
            <div class="panel registration-form">
                <div class="panel-body">

                    <div class="text-center">
                        <h4 class="content-group-lg">
                            Create affiliate channel
                        </h4>
                    </div>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                             <span>General info</span>
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.Name)
                                    @Html.TextBoxFor(x => x.Name, new { @class = "form-control", tabindex = 1, placeholder = "Affiliate channel name", required = "required", maxlength = "50" })
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.Label("Status")<br />
                                    @Html.DropDownList("Status", Model.ListStatus, new { @class = "select", required = "required", style = "width: 250px" })
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Campaigns")<br />
                                    @Html.DropDownList("CampaignId", Model.ListCampaign, new { @class = "select", required = "required", style = "width: 250px" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Affiliates")<br />
                                    @Html.DropDownList("AffiliateId", Model.ListAffiliate, new { @class = "select", required = "required", style = "width: 250px" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Data format")<br />
                                    @Html.DropDownList("DataFormat", Model.ListDataFormat, new { @class = "select", required = "required", style = "width: 250px", disabled = "disabled" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Timeout")<br />
                                    @Html.TextBoxFor(x => x.Timeout, new { @class = "form-control", tabindex = 1, placeholder = "timeout", required = "required" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group" id="revenue_div">
                                    @Html.Label("Notes")<br />
                                    @Html.TextAreaFor(x => x.Note, new { @class = "form-control", tabindex = 1, placeholder = "" })
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    @{ Html.RenderAction("Integration", "Affiliatechannel", new { StepIndex = 2, Show = 1 }); }

                    @if (currentUser.UserTypeId == SharedData.NetowrkUserTypeId || currentUser.UserTypeId == SharedData.BuiltInUserTypeId)
                    {
                        stepIndex++;

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Pricing options</span>
                        </h6>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group" id="value_div">
                                    @Html.Label("Network target revenue %", new { id = "option_value" })<br />
                                    @Html.TextBoxFor(x => x.MinPriceOptionValue, new { @class = "form-control", tabindex = 1, placeholder = "Min price option value", required = "required" })<br />
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group" id="revenue_div">
                                    @Html.Label("Network minimum revenue $")<br />
                                    @Html.TextBoxFor(x => x.MinRevenue, new { @class = "form-control", tabindex = 1, placeholder = "Minimum revenue", required = "required" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Affiliate price method")<br />
                                    @Html.DropDownList("AffiliatePriceMethod", Model.ListAffiliatePriceMethod, new { @class = "form-control", required = "required" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    @Html.Label("Affiliate price")<br />
                                    @Html.TextBoxFor(x => x.AffiliatePrice, new { @class = "form-control", tabindex = 1, @type="number", required = "required" })
                                </div>
                            </div>

                        </div>
                    </fieldset>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Filter options</span>
                        </h6>

                        <div class="row">
                            <div class="col-sm-1">
                                <select id="filter_templates" class="form-control">
                                    @foreach (var f in Model.Filters)
                                    {
                                        <option value="@f.Id">@f.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-sm-1">
                                <button id="filter_add" type="button" class="btn btn-default btn-sm">Add</button>
                            </div>
                        </div>
                        <table id="conditions" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th width="10%">Field</th>
                                    <th width="15%">Condition</th>
                                    <th width="73%">Value</th>
                                    <td width="2%"></td>
                                    <td width="2%"></td>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </fieldset>

                    <fieldset class="step" id="step@(stepIndex++)">

                        <h6 class="form-wizard-title text-semibold">
                            <span class="form-wizard-count">@(stepIndex)</span>
                            <span>Blacklist options</span>
                        </h6>

                        <div>
                            <button id="bl_add" type="button" class="btn btn-default btn-sm">Add</button>
                        </div>
                        <table id="blacklist" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Value</th>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var si in Model.CustomBlackLists)
                                {
                                    <tr>
                                        <td>
                                            <select class=".fields" style="width: 400px">
                                                @foreach (var t in Model.CampaignTemplate)
                                                {
                                                    <option value="@t.TemplateField" @Html.Raw(si.TemplateField == t.TemplateField ? "selected" : "")>@(t.TemplateField + "-" + t.Description)</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <textarea class="form-control" style="resize: none;">@si.Value</textarea>
                                        </td>
                                        <td><div class="bl_remove"><i class="glyphicon glyphicon-remove red"></i></div></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </fieldset>
                    }

                    <div style="color:red">
                        @Html.ValidationSummary()
                    </div>

                    <div class="form-wizard-actions">
                        @Html.HiddenFor(x => x.AffiliateChannelId)
@if (currentUser.UserTypeId != SharedData.NetowrkUserTypeId && currentUser.UserTypeId != SharedData.BuiltInUserTypeId)
{
                        @Html.HiddenFor(x => x.MinPriceOptionValue)
                        @Html.HiddenFor(x => x.MinRevenue)
}
                        <input class="btn btn-default" id="validation-back" value="Back" type="reset">
                        <input class="btn btn-info" id="validation-next" value="Next" type="submit">
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@{ Html.RenderAction("Integration", "Affiliatechannel", new { StepIndex = 2, Show = 0 }); }

<!-- Basic modal -->
<div id="modal_default" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h5 class="modal-title">Template</h5>
            </div>

            <div class="modal-body">
                <textarea id="xml_template" class="form-control" rows="15"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
                <button id="load_template_btn" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div id="modal_blacklist_value" class="modal fade">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <label>Add value</label><br />
                <input id="new_blacklist_value" name="new_blacklist_value" /><button id="add_new_blacklist_value">Add</button><br /><br />

                <div id="blacklist_values">
                    <div id="blacklist_values"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- /basic modal -->